<style type="text/css">
    .grid-info {
        background-color: #efefef;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .grid-info span {
        font-size: 18px;
    }
    
    .clearfix:before,
    .clearfix:after {
        content: " ";
        display: table;
    }
    
    .clearfix:after {
        clear: both;
    }
    
    .grid-wrapper {
        position: relative;
        height: 460px;
    }
    
    .grid {
        position: absolute;
        top: 0;
        width: 100%;
        border-spacing: 0;
    }
    
    .img-polaroid {
        position: absolute;
        top: 0;
        padding: 0;
        width: 100%;
        height: auto;
    }
    
    rect.grid-item.grid-item-success {
        fill: rgba(231, 76, 60, .8);
    }
    
    rect.grid-item.grid-item-error {

        fill: rgba(0, 163, 136, .5);
    }
    
    #zoom_01 {
        width: 400px;
    }
    
    .img-polaroid {
        position: absolute;
        z-index: 1;
    }
    
    #canvas {
        position: absolute;
        top: 0;
        z-index: 10;
    }
    
    .zoomContainer {
        z-index: 100;
    }
    .zoomLens {
        height: 70px;
        width: 70px;
    }
    
    main {
        / / margin-bottom: 20 px;
    }
    
    .example-list {
        margin-bottom: 40px;
    }
    
    .example-list-item {
        position: relative;
        width: 20%;
        float: left;
        margin: 0;
        overflow: hidden;
        box-sizing: border-box;
    }
    
    .example-list-item:hover .description {
        opacity: 1;
        left: 0;
    }
    
    .example-list-item .description {
        position: absolute;
        bottom: 0;
        display: block;
        text-align: center;
        width: 100%;
        color: white;
        font-family: sans-serif;
        font-weight: 100;
        letter-spacing: 1px;
        background-color: rgba(0, 0, 0, 0.6);
    }
    
    #next-slide {
        float: right;
    }
    #difficulty {
        width: 100%;
    }

    .progress {
        margin-bottom: 0;
        margin-top: 20px;
    }


    /* Portrait and Landscape */
@media only screen
  and (max-device-width: 1024px)
  and (-webkit-min-device-pixel-ratio: 1) {

}


</style>




<header class="site-header clearfix">
    <div>
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a> Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>

            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div>
</header>

<main class="site-content clearfix">
    <div class="row clearfix">
        <div class="span6">
            <div id="grid-info" class="grid-info">
                <h1 id="question">Select which grid sections contain cancer cells</h1>
                <p>
                    If you see cancer cells:
                    <br/> Click once for <span class="text-error">yes</span>
                    <br/> Double click for <span class="text-success">no</span>
                </p>

    <hr>
                <!--<div class="info">-->
                <!--<div>Total tasks: <span id="total"></span></div>-->
                <!--<div>Completed tasks: <span id="done"></span></div>-->
                <!--</div>-->

                <!--<div>You clicked on Row: <span id="result-row"></span></div>-->
                <!--<div>You clicked on Column: <span id="result-column"></span></div>-->
                <!--<div>You clicked on item #: <span id="result-item"></span></div>-->
                <!--<br/>-->

                <p>Please select an image difficulty level:</p>
                <select id="difficulty">
                    <option value="1">1 - Super easy</option>
                    <option value="2">2 - Easy</option>
                    <option value="3">3 - Average</option>
                    <option value="4">4 - Difficult</option>
                    <option value="5">5 - Very difficult</option>
                </select>

                <!--<select id="grid_size">-->
                <!--<option value="2">2x2</option>-->
                <!--<option value="3">3x3</option>-->
                <!--<option value="4">4x4</option>-->
                <!--<option value="5">5x5</option>-->
                <!--<option value="6">6x6</option>-->
                <!--</select>-->
<br/>
                <br/>
                <button class="btn" id="reset">Reset</button>
                <button class="btn" id="select-all" value="all">Select All</button>
                <button class="btn btn-answer btn-success" id="next-slide" value="next">Next slide</button>


                <div class="progress progress-striped">
                    <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
                </div>
            </div>
        </div>
        <div class="span6 wrapper grid-wrapper" id="grid-wrapper">

            <a id="photo-link"></a>

            <div id="canvas"></div>
        </div>
    </div>
</main>



<div class="row example-list clearfix">
    <h2>Cell Examples</h2>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/cancer-cells.jpg" alt="" />
        <figcaption class="description">Cancer Cells</figcaption>
    </figure>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/cancer-cells2.jpg" alt="" />
        <figcaption class="description">Cancer Cells</figcaption>
    </figure>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/healthy-cells.jpg" alt="" />
        <figcaption class="description">Healthy cells</figcaption>
    </figure>

    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/blood-cells.jpg" alt="" />
        <figcaption class="description">Blood cells</figcaption>
    </figure>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/stroma-and-blood-cells.jpg" alt="" />
        <figcaption class="description">Stroma and blood cells</figcaption>
    </figure>
</div>

<script type="text/javascript" async="async">
    "use strict";

    /**
     *
     * Grid Constructor function
     *
     */
    function Grid(task) {
        this.canvas;
        this.grid = [];
        this.grid__item_active;
        this.task = task;
        this.task.image_difficulty = 1;
        this.cheese = "asfasdf";
    }


    /**
     *
     * Main initializing method
     *
     */
    Grid.prototype.init = function() {

        this.init_zoom();
        this.create_grid(6, 6);
        this.activate_cell();
        this.task;
        var _this = this;

        $("#grid_size").on("change", $.proxy(this.change_grid, this));
        $("#difficulty").on("change", $.proxy(this.image_difficulty, this));
        $("#reset").on("click", $.proxy(this.change_grid, this));

        $("#select-all").on("click", function() {
            $.each($( _this.grid ), function(key, value) {
                value.has_cancer = true;
                value.node.setAttribute("class", "grid-item grid-item-success");
            });

        });
    };


    /**
     *
     * For initializing the Zoom functionality
     *
     */
    Grid.prototype.init_zoom = function() {
        $(".img-polaroid").elevateZoom({
            scrollZoom: true,
            minZoomLevel: .6,
            maxZoomLevel: .6,
            responsive: true,
            cursor: 'pointer',
            zoomWindowPosition: "grid-info",
            lensFadeIn: 500,
            lensFadeOut: 500,
            zoomWindowWidth: 455,
            zoomWindowHeight: 455,
        });

    };



    /**
     *
     * For creating a grid overlayed over image
     *
     */
    Grid.prototype.create_grid = function(rows, columns) {
        this.canvas = Raphael("canvas", $(".img-polaroid").width(), $(".img-polaroid").height());
        var gridHeight = $(".img-polaroid").height() / columns;
        var gridWidth = $(".img-polaroid").width() / rows;

        var x, y;
        for (y = 0; y < rows; y += 1) {
            for (x = 0; x < columns; x += 1) {

                var offsetH = y;
                var offsetW = x;
                var moveDown = (y + gridHeight - offsetH) * y;
                var moveRight = (x + gridWidth - offsetW) * x;

                var grid_item = this.canvas.rect(moveRight, moveDown, gridWidth, gridHeight)
                    .attr({
                        "stroke": "#fff"
                    });
                grid_item.node.setAttribute("class", "grid-item");


                grid_item.x = x;
                grid_item.y = y;
                grid_item.has_cancer = null;

                this.grid.push(grid_item);

            }
        }
    };


    Grid.prototype.activate_cell = function() {
        var delay = 250;
        var clicks = 0;
        var timer = null;
        var _this = this;

        $("body").on("click touchstart", ".zoomLens", function(evt) {

            evt.preventDefault();
            clicks++; //count clicks

            this.grid__item_active = _this.find_closest();

            var grid__item_active = this.grid__item_active;
            var grid__item_node = this.grid__item_active.node;
            var grid__item_active_className = grid__item_node.className.animVal;


            if (clicks === 1) {
                timer = setTimeout(function() {

                    if (grid__item_active_className != "grid-item grid-item-success") {
                        grid__item_node.setAttribute("class", "grid-item grid-item-success");
                        grid__item_active.has_cancer = true;
                    } else {
                        grid__item_node.setAttribute("class", "grid-item");
                        grid__item_active.has_cancer = null;
                    } //after action performed, reset counter
                    clicks = 0;
                }, delay);
            } else {
                clearTimeout(timer); //prevent single-click action
                grid__item_node.setAttribute("class", "grid-item grid-item-error");
                grid__item_active.has_cancer = false;

                clicks = 0;
            }
        });
    };


    /**
     *
     * Loop through the grid items
     * and find the closest matching grid
     * that have the clicked coordinates
     *
     */
    Grid.prototype.find_closest = function() {

        var _this = this;
        var active_node;


        var target = $(".zoomLens");
        var target_pos = {
            x: parseInt(target.css("left")),
            y: parseInt(target.css("top"))
        };

        // Center the zoom cursor to middle of square
        target_pos.x = target_pos.x + 34.85;
        target_pos.y = target_pos.y + 34.85;

        // Find the closet grid item
        $.each(this.grid, function(key, value) {

            if (value.isPointInside(target_pos.x, target_pos.y)) {
                active_node = value;
                _this.show_results(value);
                //_this.grid.push(obj);

            }
        });
        return active_node;
    };

    /**
     *
     * Add click listener to each grid cell
     *
     */
    Grid.prototype.show_results = function(active_node) {
        $("#result-row").text(active_node.y);
        $("#result-column").text(active_node.x);
        $("#result-item").text(active_node.id + 1);
    };


    Grid.prototype.change_grid = function() {
        var str = "";
        $("#grid_size option:selected").each(function() {
            str = $(this).val();
        });

        this.grid = [];
        this.canvas.clear();
        $("svg").remove();
        this.create_grid(6, 6);

        $.each(this.grid, function(key, value) {
            value.id = key;
        });

    };

    Grid.prototype.image_difficulty = function() {
        var val = "";
        $("#difficulty option:selected").each(function() {
            val = $(this).val();
        });
        this.task.image_difficulty = val;

    };





    function loadUserProgress() {
        pybossa.userProgress('mvp-01').done(function(data) {
            var pct = Math.round((data.done * 100) / data.total);
            $("#progress").css("width", pct.toString() + "%");
            $("#progress").attr("title", pct.toString() + "% completed!");
            $("#progress").tooltip({
                'placement': 'bottom'
            });
            $("#total").text(data.total);
            $("#done").text(data.done);
        });
    }



    $(".touch .zoomLens").on("touchend", function() {
        $(".zoomWindow").css("display", "block !important");
    });


    pybossa.taskLoaded(function(task, deferred) {

        if (!$.isEmptyObject(task)) {
            // load image from flickr
            var img = $('<img />');
            img.load(function() {
                // continue as soon as the image is loaded
                deferred.resolve(task);
            });
            img.attr('src', task.info.url_b).css('height', 460);
            img.attr('data-zoom-image', task.info.url_b);
            img.addClass('img-polaroid');
            task.info.image = img;

            task.answer = [];
            task.cheese = "sdfasdf";

            //task.answer.image_difficulty = 1;

        } else {
            deferred.resolve(task);
        }
    });

    pybossa.presentTask(function(task, deferred) {

        if (!$.isEmptyObject(task)) {

            loadUserProgress();

            $('#photo-link').html('').append(task.info.image);
            $("#question").html(task.info.question);
            $('#task-id').html(task.id);

            // Init my Grid Constructor
            var r = new Grid(task);
            r.init();


            $('.btn-answer').off('click').on('click', function(evt) {
                var btn = $(this);
                var answer = btn.attr("value");
                if (typeof answer != 'undefined') {

                    $.each(r.grid, function(key, value) {
                        var obj = {
                            column: value.x,
                            row: value.y,
                            answer: value.has_cancer
                        };
                        r.task.answer.push(obj);
                    });

                    //r.task.image_difficulty = r.task.image_difficulty;
                    //r.task.push()

                    //console.log(r.cheese);



                    pybossa.saveTask(task.id, task.answer).done(function(data) {

                        console.log(task);

//                        $("svg").remove();
//                        $(".zoomContainer").remove();
//                        $(".zoomWindowContainer").remove();
//                        deferred.resolve();
                    });

                    $("#loading").fadeIn(500);

                } else {
                    $("#error").show();
                }
            });

            $("#loading").hide();
        } else {
            $(".skeleton").hide();
            $("#loading").hide();
            $("#finish").fadeIn(500);
        }
    });


    $(function(){
        pybossa.run('mvp-01');
    })
</script>




