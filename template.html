<style type="text/css">

    /*
     * Utility to clear floats
     */
    .clearfix:before,
    .clearfix:after {
        content: " ";
        display: table;
    }

    .clearfix:after {
        clear: both;
    }

    /*
     * Left column with grid infomation
     */

    .grid-info {
        background-color: #efefef;
        padding: 20px;
        box-sizing: border-box;
    }

    .grid-info span {
        font-size: 18px;
    }

    /*
     * Right column including grid
     */
    .grid-wrapper {
        position: relative;
        height: 460px;
    }

    .grid {
        position: absolute;
        top: 0;
        width: 100%;
        border-spacing: 0;
    }

    .img-polaroid {
        position: absolute;
        z-index: 1;
        top: 0;
        padding: 0;
        width: 100%;
        height: auto;
    }

    rect.grid-item.grid-item-success {
        fill: rgba(231, 76, 60, .8);
    }

    rect.grid-item.grid-item-error {

        fill: rgba(0, 163, 136, .5);
    }

    #zoom_01 {
        width: 400px;
    }

    #canvas {
        position: absolute;
        top: 0;
        z-index: 10;
    }

    .zoomContainer {
        z-index: 100;
    }

    .zoomLens {
        height: 70px;
        width: 70px;
    }

    .example-list {
        margin-bottom: 40px;
    }

    .example-list-item {
        position: relative;
        width: 20%;
        float: left;
        margin: 0;
        overflow: hidden;
        box-sizing: border-box;
    }

    .example-list-item:hover .description {
        opacity: 1;
        left: 0;
    }

    .example-list-item .description {
        position: absolute;
        bottom: 0;
        display: block;
        text-align: center;
        width: 100%;
        color: white;
        font-family: sans-serif;
        font-weight: 100;
        letter-spacing: 1px;
        background-color: rgba(0, 0, 0, 0.6);
    }

    .nextSlideBtn {
        float: right;
    }

    #difficulty {
        width: 100%;
    }

    .progress {
        margin-bottom: 0;
        margin-top: 20px;
    }
</style>

<header class="site-header clearfix">
    <div>
        <div id="img-difficulty-message" class="alert alert-error" style="display:none;">
            <!--<a class="close">×</a>-->
            <strong>Please select an image difficulty from the dropdown below.</strong>
        </div>
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a> Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>

            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div>
</header>

<main class="site-content clearfix">
    <div class="row clearfix">

        <!--Left hand side-->
        <div class="span6">
            <div id="grid-info" class="grid-info">

                <div class="grid-info-instructions">
                    <h1 id="question">Select which grid sections contain cancer cells</h1>

                    <p>
                        If you see cancer cells:
                        <br/> Click once for <span class="text-error">yes</span>
                        <br/> Double click for <span class="text-success">no</span>
                    </p>
                </div>

                <!--<select class="grid-info-difficulty" id="difficulty">-->
                <!--<option value="0" selected>Please select an image difficulty level:</option>-->
                <!--<option value="1">1 - Very easy</option>-->
                <!--<option value="2">2 - Easy</option>-->
                <!--<option value="3">3 - Average</option>-->
                <!--<option value="4">4 - Difficult</option>-->
                <!--<option value="5">5 - Very difficult</option>-->
                <!--</select>-->

                <div class="grid-info-buttons">
                    <button class="btn" id="deselectBtn">Deselect All</button>
                    <button class="btn" id="selectAllBtn" value="all">Select All</button>
                    <button class="btn btn-answer btn-success nextSlideBtn" id="nextSlideBtn" value="next">Next slide</button>
                </div>

                <div class="progress progress-striped">
                    <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!--Right hand side-->
        <div class="span6 wrapper grid-wrapper" id="grid-wrapper">
            <a id="photo-link"></a>

            <div class="canvas" id="canvas"></div>
        </div>
    </div>
</main>

<div class="row example-list clearfix">
    <h2>Cell Examples</h2>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/cancer-cells.jpg" alt=""/>
        <figcaption class="description">Cancer Cells</figcaption>
    </figure>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/cancer-cells2.jpg" alt=""/>
        <figcaption class="description">Cancer Cells</figcaption>
    </figure>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/healthy-cells.jpg" alt=""/>
        <figcaption class="description">Healthy cells</figcaption>
    </figure>

    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/blood-cells.jpg" alt=""/>
        <figcaption class="description">Blood cells</figcaption>
    </figure>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/stroma-and-blood-cells.jpg" alt=""/>
        <figcaption class="description">Stroma and blood cells</figcaption>
    </figure>
</div>

<script type="text/javascript" async="async">
    "use strict";

    /*
     * Take a time stamp of the time the page loads
     */
    var oldTime;


    /**
     * grid.js
     * Grid Constructor function
     *
     */
    function Grid(task) {
        this.canvas;
        this.task = task;

    }

    /**
     *
     * Main initializing method
     *
     */
    Grid.prototype.init = function () {

        this.create_grid();
        this.activate_cell();
        var _this = this;

        // Listening for click events
//        $("#difficulty").on("change", $.proxy(this.image_difficulty, this));

        /**
         *
         * Initializing the elevateZoom library
         * www.elevateweb.co.uk/image-zoom
         *
         */
        $(".img-polaroid").elevateZoom({
            zoomWindowPosition: "grid-info",
            lensFadeIn: 500,
            lensFadeOut: 500,
            // Changing these two numbers changes the zoomWindowWidth
            // Also the side of the .zoomLens (box over image)
            zoomWindowWidth: 455,
            zoomWindowHeight: 455,
        });

    };


    /**
     *
     * For creating a grid overlayed over the image
     *
     */
    Grid.prototype.create_grid = function () {

        /*
         * Using raphael so we can use methods like isPointInside
         * and calculate how close the click on grid are.
         * Also nice and cross browser :D
         *
         * Maybe d3 might have been better!?
         */
        var rows = 6,
            columns = 6,
            canvas = Raphael("canvas", $(".img-polaroid").width(), $(".img-polaroid").height()),
            gridHeight = $(".img-polaroid").height() / columns,
            gridWidth = $(".img-polaroid").width() / rows;

        // rows = 6 and columns = 6
        // creates 36 grid squares in raphael
        var x, y;
        for (y = 0; y < rows; y += 1) {
            for (x = 0; x < columns; x += 1) {

                var offsetH = y,
                    offsetW = x,
                    moveDown = (y + gridHeight - offsetH) * y,
                    moveRight = (x + gridWidth - offsetW) * x,
                    gridSquare = canvas.rect(moveRight, moveDown, gridWidth, gridHeight).attr({
                        "stroke": "#fff"
                    });

                gridSquare.node.setAttribute("class", "grid-item");

                gridSquare.column = x;
                gridSquare.row = y;
                gridSquare.has_cancer = null;

                // Save all grid squares in array within main task object
                // We can then grab this when saving the info at the end
                this.task.answer.squares.push(gridSquare);

            }
        }
    };


    /**
     *
     * Listen for lick on .zoomLens and find the closed square
     *
     */
    Grid.prototype.activate_cell = function () {

        var clicks = 0;
        var timer = null;
        var _this = this;

        $("body").on("click touchstart", ".zoomLens", function (evt) {

            evt.preventDefault();
            clicks++; //count clicks

            // Find the cloest grid square to click on the zoomLens

            var activeSquare = _this.find_closest();
            var activeSquareNode = activeSquare.node;

            // Not able to use jQuery .click or .dblclick for some reason i can't remember
            // If we can then should use jQuery...might be quicker and easier

            if (clicks === 1) {
                timer = setTimeout(function () {
                    // Adds and removes classes to grid squares making them red or green
                    if (activeSquareNode.className.animVal != "grid-item grid-item-success") {
                        activeSquareNode.setAttribute("class", "grid-item grid-item-success");
                        activeSquare.has_cancer = true;
                    } else {
                        activeSquareNode.setAttribute("class", "grid-item");
                        activeSquare.has_cancer = null;
                    } //after action performed, reset counter
                    clicks = 0;
                }, 250);
            } else {
                clearTimeout(timer); //prevent single-click action
                activeSquareNode.setAttribute("class", "grid-item grid-item-error");
                activeSquare.has_cancer = false;
                clicks = 0;
            }
        });
    };

    /**
     *
     * Loop through the grid items
     * and find the closest matching grid
     * that have the clicked coordinates
     *
     */
    Grid.prototype.find_closest = function () {

        var _this = this,
            activeSquare,
            target = $(".zoomLens"),
            target_pos = {
                x: parseInt(target.css("left")),
                y: parseInt(target.css("top"))
            };

        // Center the zoom cursor to middle of square
        target_pos.x = target_pos.x + 34.85;
        target_pos.y = target_pos.y + 34.85;

        // Find the closet grid item
        $.each(_this.task.answer.squares, function (key, value) {
            if (value.isPointInside(target_pos.x, target_pos.y)) {
                activeSquare = value;
            }
        });
        return activeSquare;
    };


    Grid.prototype.selectAllSquares = function () {
        for (var i = 0; i < this.task.answer.squares.length; i++) {
            var gridSquare = this.task.answer.squares[i],
                gridSquareNode = this.task.answer.squares[i].node;
            gridSquareNode.setAttribute("class", "grid-item grid-item-success");
        }
    }
    Grid.prototype.deselectAllSquares = function () {
        for (var i = 0; i < this.task.answer.squares.length; i++) {
            var gridSquare = this.task.answer.squares[i],
                gridSquareNode = this.task.answer.squares[i].node;
            gridSquareNode.setAttribute("class", "grid-item");
        }
    }


    // Listen to when the image difficulty select is chnages
    // and save it into the task object
    Grid.prototype.image_difficulty = function () {
        var val = "";
        $("#difficulty option:selected").each(function () {
            val = $(this).val();
        });
        $("#img-difficulty-message").fadeOut(500);
        this.task.answer.img_diff = parseInt(val);

    };


    /*
     *
     * End of Grid class
     *
     * */








    /*
     *
     * Helpful functions
     *
     *
     */

    // Loads user progress into Grid info
    function loadUserProgress() {
        pybossa.userProgress('mvp-02').done(function (data) {
            var pct = Math.round((data.done * 100) / data.total);
            $("#progress").css("width", pct.toString() + "%");
            $("#progress").attr("title", pct.toString() + "% completed!");
            $("#progress").tooltip({
                'placement': 'bottom'
            });
            $("#total").text(data.total);
            $("#done").text(data.done);
        });
    }

    // Calculates seconds from milisecond timestamp
    function secondsToString(seconds) {
        var time = {};
        //var numdays = Math.floor((seconds % 31536000) / 86400);
        //var numhours = Math.floor(((seconds % 31536000) % 86400) / 3600);
        var numminutes = Math.floor((((seconds % 31536000) % 86400) % 3600) / 60);
        var numseconds = (((seconds % 31536000) % 86400) % 3600) % 60;
        time.minutes = numminutes;
        time.seconds = numseconds;
        return time;
    }

    // uses device.js and works out what device we are using
    function whatDevice() {
        var desktop = device.desktop(),
            mobile = device.mobile(),
            tablet = device.tablet(),
            portrait = device.portrait(),
            landscape = device.landscape(),
            iphone = device.iphone(),
            android = device.android(),
            androidTablet = device.androidTablet(),
            blackberryTablet = device.blackberryTablet();


        if (desktop) return "Desktop";
        if (mobile && portrait)    return "Mobile portrait";
        if (mobile && portrait)    return "Mobile landscape";
        if (tablet && portrait)    return "Tablet portrait";
        if (tablet && landscape)    return "Tablet landscape";
    }

    // Using useragent we find what browser we are using
    function whatBrowser() {
        alert("sdfsdf");
        var ua = navigator.userAgent, tem,
            M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
        if (/trident/i.test(M[1])) {
            tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
            return 'IE ' + (tem[1] || '');
        }
        if (M[1] === 'Chrome') {
            tem = ua.match(/\bOPR\/(\d+)/);
            if (tem != null) return 'Opera ' + tem[1];
        }
        M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
        if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
        return M.join(' ');
    }


    /*
     *
     * PyBossa stuff
     * - .taskLoaded
     * - .presentTask
     *      - .saveTask
     *
     */

    pybossa.taskLoaded(function (task, deferred) {

        if (!$.isEmptyObject(task)) {
            // load image from flickr
            var img = $('<img />');
            img.load(function () {
                // continue as soon as the image is loaded
                deferred.resolve(task);
            });

            img.attr('src', task.info.url_b).css('height', 460);
            img.attr('data-zoom-image', task.info.url_b);
            img.addClass('img-polaroid');
            task.info.image = img;


            task.answer = {
                squares: [],
                img_diff: 0,
                timeTaken: "",
                device: "",
                browser: "",
                img: task.info.url_b
            }

        } else {
            deferred.resolve(task);
        }
    });

    pybossa.presentTask(function (task, deferred) {

        if (!$.isEmptyObject(task)) {

            loadUserProgress();
            oldTime = new Date();


            $('#photo-link').html('').append(task.info.image);
            $("#question").html(task.info.question);
            $('#task-id').html(task.id);

            // Init my Grid Constructor
            var r = new Grid(task);
            r.init();
            //$("#select-all").on("click", r.selectAllSquares );

            var selectBtn = document.getElementById("selectAllBtn");
            selectBtn.onclick = function () {
                r.selectAllSquares();
            }
            var deselectBtn = document.getElementById("deselectBtn");
            deselectBtn.onclick = function () {
                r.deselectAllSquares();
            }


            // On click of the "next slide" button
            $('.btn-answer').off('click').on('click', function (evt) {

                // If we are on project mvp01 save the task normally
                // Else check if the image difficulty has been set and then save task

                /*
                 * Conditional to check if the image difficulty has been set
                 */
                if ($("#difficulty option:selected").val() != 0) {


                    var newTime = new Date();
                    var ms = newTime - oldTime;
                    var x = ms / 1000;

                    var str = task.info.url_b;
                    var result = str.replace("//citscitools.cancerresearchuk.org/static/img/mvp-01/", "");

                    var answer = {
                        squares: [],
                        imgDiff: r.task.answer.img_diff,
                        timeTaken: secondsToString(x),
                        device: whatDevice(),
                        browser: whatBrowser(),
                        imgNumber: result
                    };

//                    mixpanel.track('Time taken', {
//                        'Time taken': answer.timeTaken
//                    });

                    // Change the square object to have clearer values
                    $.each(r.task.answer.squares, function (key, value) {
                        var obj = {
                            column: value.column,
                            row: value.row,
                            answer: value.has_cancer
                        };
                        answer.squares.push(obj);
                    });

                    console.log(answer);


                    /*
                     * Save the task information and send to PyBossa
                     */
                    pybossa.saveTask(task.id, answer).done(function (data) {

                        deferred.resolve();
                        $("svg").remove();
                        $(".zoomContainer").remove();
                        $(".zoomWindowContainer").remove();
                        r.create_grid();

                    });

                    $("#img-difficulty-message").hide();
                    $("#loading").fadeIn(500);

                } else {
                    $("#img-difficulty-message").fadeIn(500);
                }


            });

            $("#loading").hide();
        } else {
            $(".skeleton").hide();
            $("#loading").hide();
            $("#finish").fadeIn(500);
        }
    });


    /**
     *
     * app.js
     * General app stuff like inits and buttons listeners
     *
     */

    $(function () {
        pybossa.run('mvp-02');
    })

</script>




