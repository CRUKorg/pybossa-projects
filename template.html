<style type="text/css">


     .zoomContainer {
        z-index: 1999;
    }

    /*
     * For styling the tutorial modal component
     * Need to make this responsive and cross browser compatable
     */

    .modal {
        z-index: 1200 !important;
        width: 800px;
        margin-left: -400px;
        top: 45%;
    }

    .modal .modal-body {
        max-height: 600px;
        display: table;
        padding: 0;
    }
    
    .modal-backdrop {
        z-index: 1000 !important;
    }
    .zoomContainer {
        z-index: 2000 !important;
    }
    

    /*
     * Modal body split into two sections
     * left is the .modal-image (contains image and carousel)
     * right is the .modal-info (contains text)
     */

    .modal .modal-body .modal-image,
    .modal .modal-body .modal-info {
        float: left;
        word-break: keep-all;
    }

    .modal .modal-body .modal-image {
        width: 460px;
    }

    .modal .modal-body .modal-info {
        width: 300px;
        padding: 20px;
    }

    .modal .modal-body .carousel {
        margin-bottom: 0;
    }

    .modal .modal-body .carousel-control {
        top: 50%;
    }



    /*
     * Utility to clear floats
     */
    .clearfix:before,
    .clearfix:after {
        content: " ";
        display: table;
    }

    .clearfix:after {
        clear: both;
    }

    /*
     * Left column with grid infomation
     */

    .grid-info {
        background-color: #efefef;
        padding: 20px;
        box-sizing: border-box;
    }

    .grid-info span {
        font-size: 18px;
    }

    /*
     * Right column including grid
     */
    .grid-wrapper {
        position: relative;
        height: 460px;
    }

    .grid {
        position: absolute;
        top: 0;
        width: 100%;
        border-spacing: 0;
    }

    .img-polaroid {
        position: absolute;
        z-index: 1;
        top: 0;
        padding: 0;
        width: 100%;
        height: auto;
    }

    rect.grid-item.grid-item-success {
        fill: rgba(231, 76, 60, .8);
    }

    rect.grid-item.grid-item-error {

        fill: rgba(0, 163, 136, .5);
    }

    #zoom_01 {
        width: 400px;
    }

    #canvas {
        position: absolute;
        top: 0;
        z-index: 10;
    }

    .zoomContainer {
        z-index: 100;
    }

    .zoomLens {
        height: 70px;
        width: 70px;
    }

    .example-list {
        margin-bottom: 40px;
    }

    .example-list-item {
        position: relative;
        width: 20%;
        float: left;
        margin: 0;
        overflow: hidden;
        box-sizing: border-box;
    }

    .example-list-item:hover .description {
        opacity: 1;
        left: 0;
    }

    .example-list-item .description {
        position: absolute;
        bottom: 0;
        display: block;
        text-align: center;
        width: 100%;
        color: white;
        font-family: sans-serif;
        font-weight: 100;
        letter-spacing: 1px;
        background-color: rgba(0, 0, 0, 0.6);
    }

    .nextSlideBtn {
        float: right;
    }

    #difficulty {
        width: 100%;
    }

    .progress {
        margin-bottom: 0;
        margin-top: 20px;
    }

    .site-header .alert {
        text-align: center;
    }
</style>


<!--MODAL-->
<div class="row">
    <div class="span12">
        <div id="modal" class="modal hide fade">
            <div id="0" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/tutorial/cancer-cells-area.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>
                        Your task is to identify cancer cells.
                    </h1>

                    <p>
                        These are uneven, often larger cells with a mottled or blotchy surface like the ones highlighted below.
                    </p>
                </div>

            </div>

            <div id="1" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/tutorial/cancer-cells-arrows.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Here's another example of cancer cells</h1>

                    <p>
                        These are often found clustered together.
                    </p>
                </div>

            </div>

            <div id="2" class="modal-body" style="display:none">

                <div class="modal-image">
                    <div id="myCarousel" class="carousel slide">
                        <!-- Carousel items -->
                        <div class="carousel-inner">
                            <div class="active item">
                                <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/tutorial/non-cancer-cells-area.jpg" alt=""/>
                            </div>
                            <div class="item">
                                <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/tutorial/non-cancer-cells-arrows.jpg" alt=""/>
                            </div>
                        </div>
                        <!-- Carousel nav -->
                        <a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
                        <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
                    </div>
                </div>
                <div class="modal-info">
                    <h1>
                        You will see other cell types which you should ignore.
                    </h1>

                    <p>
                        These include the smaller, denser cells and the stretched wispy cells, some of these are highlighted below. We’re not looking for these cells.
                    </p>
                </div>

            </div>

            <div id="3" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/tutorial/grid.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Let’s run through an example</h1>

                    <p>
                        We have split the images up into a 6x6 grid. Some of the grid sections contain cancer cells and some of them do not. We’re going to show you what to do.
                    </p>
                </div>
            </div>

            <div id="4" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/tutorial/zoomed-in.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Look closely at the cells in each section</h1>

                    <p>
                        Like we have done here, you can hover over the cells in each section to pull up a zoomed in version and get a closer look.
                    </p>
                </div>
            </div>

            <div id="5" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/tutorial/grid-red.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>We’ve clicked once to highlight sections containing cancer cells red</h1>

                    <p>
                        Examine each section and if you think it contains cancer cells (even if you only see one or two cells) click once to turn that section red.
                    </p>
                </div>

            </div>
            <div id="6" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/tutorial/grid-red-green.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>We’ve clicked twice to highlight sections that do <b>not contain</b> cancer cells green</h1>

                    <p>
                        Examine each section and if you think it
                        <b>does not</b> contain any cancer cells, you can double click to turn that section green.
                    </p>
                    <p>
                        Before you start analysing, lets take a closer look at some samples
                    </p>
                </div>

            </div>


             <div id="7" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/tutorial/grid-red-green.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Empty sections can be left blank</h1>

                    <p>
                        You can ignore any sections that are empty, normally corner and edge sections (but not always).
                    </p>

                    <p>
                        You can then click on the green “Next slide” to move onto the next sample.
                    </p>
                </div>

            </div>






            <!--new slides added here-->

            <div id="8" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-1.jpg" id="zoom01" data-zoom-image="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-1.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Guidance Image 1 – Healthy lung epithelial cells, white blood cells, stroma and cartilage</h1>

                    <p>
                        This is a healthy section of lung. The large green outline indicates an airway. This is lined by a thin layer of lung epithelial cells. These are indicated by the small green outlines and green arrows. Take a closer look.

                        These cells, are nicely defined, form a nice orderly structure and are all fairly similar to each other. Look really closely and you’ll seen fine hair like structures facing into the airway that are responsible for wafting mucus out of your lungs. This complex, organised and uniform behaviour is lost when these cells become cancerous.

                    </p>
                </div>

            </div>
            <div id="9" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-1.jpg" id="zoom02" data-zoom-image="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-1.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Guidance Image 1 – Healthy lung epithelial cells, white blood cells, stroma and cartilage</h1>

                    <p>
                         Just inside of the epithelial cells is a single layer of white blood cells. They can also be found in dense or loose clumps nearby a tumour. They are small, round solid looking cells, indicated here with pink arrows and circles. Take a closer look.
                        Circled in orange is cartilage which provides structural support but you will not see too many of these.

                        The remaining cells, a few sections of which have been circled and indicated with purple arrows, make up the stroma. These stringy, loosely spread cells provide support and structure in both healthy organs and tumours.
                    </p>
                </div>

            </div>



            <div id="10" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-2.jpg" id="zoom03" data-zoom-image="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-2.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Guidance Image 2 – Cancer cells in chains and rings and stroma mixed with blood cells</h1>

                    <p>
                        Here we have lots of cancer cells that have formed loose chains and rings. We have circled four of these structures in red but you can see there are many more.

                        Cancer are normally unable to form organised shapes and complicated structures. However, sometimes cancer cells make a poor attempt to behave like healthy cells such as the tightly packed, single layer of healthy lung epithelial cells seen in the previous image. This is what you can see in this sample

                        Look closely at these cells and compare them with what you see with the previous healthy epithelial cells. The cells in this image aren’t as nicely defined, are very different to each other, tend to bunch up and occasionally break away to form clusters and lumps. This lack of good, organised and uniform cell behaviour is typical of cancer cells

                        In-between these rings and chains of cancer cells is the stroma, a small section of which is circled in purple. Also in the stroma are some clusters of white blood cells.
                    </p>
                </div>

            </div>
            <div id="11" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-3.jpg" id="zoom04" data-zoom-image="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-3.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Guidance Image 3 – Cancer cells in clumps and lots of stroma mixed with blood cells</h1>

                    <p>
                        Here are more cancer cells but this time formed in clusters and clumps, most of which are circled in red.

                        Look closely at the image and look at the features that differ between the cancer cells and the surrounding stroma and blood cells
                    </p>
                </div>

            </div>
            <div id="12" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-4.jpg" id="zoom05" data-zoom-image="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-4.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Guidance Image 4 – Dead cells, cancer cells in clumps, flood of stroma and lymphocytes</h1>

                    <p>
                        This image is of a very busy sample containing cancer cells, stroma and lots of small, round and solid looking blood cells

                        Look really closely inside the red circled areas and try to spot the boundary between the cancer cells and the stroma/blood cells by looking really closely at the shapes and organisation of the cells

                        The brown circle and arrow here indicates a collection of dead cells. These can be ignored
                    </p>
                </div>

            </div>
            <div id="13" class="modal-body" style="display:none">

                <div class="modal-image">
                    <img src="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-5.jpg" id="zoom06" data-zoom-image="//citscitools.cancerresearchuk.org/static/img/mvp-02/guidence-images-5.jpg" alt=""/>
                </div>
                <div class="modal-info">
                    <h1>Guidance Image 5 – Stroma, blood cells, cartilage, healthy lung epithelia, cancer cells including examples extreme nuclear pleomorphism</h1>

                    <p>
                        In this image shows you most of the cells we have talked about.

                        The green outlines some healthy lung epithelial cells. Look at uniform and well organised they are.

                        The orange outline indicates some cartilage

                        The purple circles indicates some sections of the stroma while the pink circle indicates a cluster of white blood cells

                        The red outlines indicates some clumps of cancer cells below the healthy epithelial cells. But there are more clumps of cancer cells above and to the right of the piece of cartilage. The red arrow points to some of the cancer cells that are particularly good examples of just how odd and variable cancer cells can become.

                        Like in the previous example, try to identify the boundary between cancer cells and stroma.
                    </p>
                </div>

            </div>

            <div class="modal-footer">
                <a id="prevBtn" href="#" onclick="showStep('prev')" class="btn">Previous</a>
                <a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
                <a id="startContrib" href="../mvp-02a/newtask" class="btn btn-primary" style="display:none"><i class="icon-thumbs-up"></i> Start</a>
            </div>
        </div>
    </div>
</div>





<header class="site-header clearfix">
    <div>
        <div id="success" class="alert alert-success" style="display:none">
            <h2><strong>Well done!</strong> Your answer has been saved</h2>
        </div>
        <div id="loading" class="alert alert-info" style="display:none">
           <h2> Loading next task...</h2>
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none">
            <h2><strong>The task has been completed!</strong> Thanks a lot!</h2>
        </div>
        <div id="finish" class="alert alert-success" style="display:none">
            <h2><strong>Congratulations!</strong> You have participated in all available tasks!</h2>
            <p></p>
            <div class="alert-actions">
                <a class="btn small" href="http://citscitools.cancerresearchuk.org/community/about/">Find out more here</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none">
            <h2><strong>Error!</strong> Something went wrong, please contact the site administrators</h2>
        </div>
    </div>
</header>

<main class="site-content clearfix">
    <div class="row clearfix">

        <!--Left hand side-->
        <div class="span6">
            <div id="grid-info" class="grid-info">

                <div class="grid-info-instructions">
                    mvp-02aa
                    <h1 id="question">Select which grid sections contain cancer cells</h1>

                    <p>
                        If you see cancer cells:
                        <br/> Click once for <span class="text-error">yes</span>
                        <br/> Double click for <span class="text-success">no</span>
                    </p>
                </div>

                <!--<select class="grid-info-difficulty" id="difficulty">-->
                <!--<option value="0" selected>Please select an image difficulty level:</option>-->
                <!--<option value="1">1 - Very easy</option>-->
                <!--<option value="2">2 - Easy</option>-->
                <!--<option value="3">3 - Average</option>-->
                <!--<option value="4">4 - Difficult</option>-->
                <!--<option value="5">5 - Very difficult</option>-->
                <!--</select>-->

                <div class="grid-info-buttons">
                    <button class="btn" id="selectAllBtn" value="all">Select All</button>
                    <button class="btn" id="deselectBtn">Deselect All</button>

                    <button class="btn btn-primary" id="modalBtn">Tutorial</button>
                    <button class="btn btn-answer btn-success nextSlideBtn" id="nextSlideBtn" value="next">Next slide</button>
                </div>

                <div class="progress progress-striped">
                    <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!--Right hand side-->
        <div class="span6 wrapper grid-wrapper" id="grid-wrapper">
            <a id="photo-link"></a>

            <div class="canvas" id="canvas"></div>
        </div>
    </div>
</main>

<div class="row example-list clearfix">
    <h2>Cell Examples</h2>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/cancer-cells.jpg" alt=""/>
        <figcaption class="description">Cancer Cells</figcaption>
    </figure>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/cancer-cells2.jpg" alt=""/>
        <figcaption class="description">Cancer Cells</figcaption>
    </figure>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/healthy-cells.jpg" alt=""/>
        <figcaption class="description">Healthy cells</figcaption>
    </figure>

    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/blood-cells.jpg" alt=""/>
        <figcaption class="description">Blood cells</figcaption>
    </figure>
    <figure class="example-list-item">
        <img src="//citscitools.cancerresearchuk.org/static/img/mvp-01/legend/stroma-and-blood-cells.jpg" alt=""/>
        <figcaption class="description">Stroma and blood cells</figcaption>
    </figure>
</div>

<script type="text/javascript" async="async">

    "use strict";

    /**
     * grid.js
     * Grid Constructor function
     * Its a bit of a miss match of vanilla JS and jQuery...sorry,
     * wanted to do everything in JS but for speed i did jQuery
     *
     */
    function Grid(task) {

        //Modal.call(this);

        this.task = task;
        this.activateCell();

        /**
         *
         * Initializing the elevateZoom library
         * www.elevateweb.co.uk/image-zoom
         *
         */
        $(".img-polaroid").elevateZoom({
            zoomWindowPosition: "grid-info",
            lensFadeIn: 500,
            lensFadeOut: 500,
            // Changing these two numbers changes the zoomWindowWidth
            // Also the side of the .zoomLens (box over image)
            zoomWindowWidth: 455,
            zoomWindowHeight: 455,
        });


    }

    //Grid.prototype = Object.create(Modal.prototype);

    /**
     *
     * For creating a grid overlayed over the image
     *
     */
    Grid.prototype.createGrid = function () {

        /*
         * Using raphael so we can use methods like isPointInside
         * and calculate how close the click on grid are.
         * Also nice and cross browser :D
         *
         * Maybe d3 might have been better!?
         */
        var rows = 6,
            columns = 6,
            canvas = Raphael("canvas", $(".img-polaroid").width(), $(".img-polaroid").height()),
            gridHeight = $(".img-polaroid").height() / columns,
            gridWidth = $(".img-polaroid").width() / rows;

        // creates 36 grid squares in raphael
        var x, y;
        for (y = 0; y < rows; y += 1) {
            for (x = 0; x < columns; x += 1) {

                var offsetH = y,
                    offsetW = x,
                    moveDown = (y + gridHeight - offsetH) * y,
                    moveRight = (x + gridWidth - offsetW) * x,
                    gridSquare = canvas.rect(moveRight, moveDown, gridWidth, gridHeight).attr({
                        "stroke": "#fff"
                    });

                gridSquare.node.setAttribute("class", "grid-item");

                gridSquare.column = x;
                gridSquare.row = y;
                gridSquare.has_cancer = null;

                // Save all grid squares in array within main task object
                // We can then grab this when saving the info at the end
                this.task.answer.squares.push(gridSquare);

            }
        }
    };


    /**
     *
     * Listen for lick on .zoomLens and find the closed square
     *
     */
    Grid.prototype.activateCell = function () {

        var clicks = 0;
        var timer = null;
        var _this = this;

        $("body").on("click touchstart", ".zoomLens", function (evt) {

            evt.preventDefault();
            clicks++; //count clicks

            // Find the cloest grid square to click on the zoomLens

            var activeSquare = _this.findClosestSquare();
            var activeSquareNode = activeSquare.node;

            // Not able to use jQuery .click or .dblclick for some reason i can't remember
            // If we can then should use jQuery...might be quicker and easier

            if (clicks === 1) {
                timer = setTimeout(function () {
                    // Adds and removes classes to grid squares making them red or green
                    if (activeSquareNode.className.animVal != "grid-item grid-item-success") {
                        activeSquareNode.setAttribute("class", "grid-item grid-item-success");
                        activeSquare.has_cancer = true;
                    } else {
                        activeSquareNode.setAttribute("class", "grid-item");
                        activeSquare.has_cancer = null;
                    } //after action performed, reset counter
                    clicks = 0;
                }, 250);
            } else {
                clearTimeout(timer); //prevent single-click action
                activeSquareNode.setAttribute("class", "grid-item grid-item-error");
                activeSquare.has_cancer = false;
                clicks = 0;
            }
        });
    };

    /**
     *
     * Loop through the grid items
     * and find the closest matching grid
     * that have the clicked coordinates
     *
     */
    Grid.prototype.findClosestSquare = function () {

        var _this = this,
            activeSquare,
            target = $(".zoomLens"),
            target_pos = {
                x: parseInt(target.css("left")),
                y: parseInt(target.css("top"))
            };

        // Center the zoom cursor to middle of square
        target_pos.x = target_pos.x + 34.85;
        target_pos.y = target_pos.y + 34.85;

        // Find the closet grid item
        $.each(_this.task.answer.squares, function (key, value) {
            if (value.isPointInside(target_pos.x, target_pos.y)) {
                activeSquare = value;
            }
        });
        return activeSquare;
    };


    Grid.prototype.selectAllSquares = function () {
        for (var i = 0; i < this.task.answer.squares.length; i++) {
            var gridSquare = this.task.answer.squares[i],
                gridSquareNode = this.task.answer.squares[i].node;
            gridSquare.has_cancer = true;
            gridSquareNode.setAttribute("class", "grid-item grid-item-success");
        }
    }
    Grid.prototype.deselectAllSquares = function () {
        for (var i = 0; i < this.task.answer.squares.length; i++) {
            var gridSquare = this.task.answer.squares[i],
                gridSquareNode = this.task.answer.squares[i].node;
            gridSquare.has_cancer = null;
            gridSquareNode.setAttribute("class", "grid-item");
        }
    }


    /*
     *
     * End of Grid class
     *
     * */









    /*
     *
     * Helpful functions
     *
     *
     */

    // Loads user progress into Grid info
    function loadUserProgress() {
        pybossa.userProgress('mvp-02a').done(function (data) {
            var pct = Math.round((data.done * 100) / data.total);
            $("#progress").css("width", pct.toString() + "%");
            $("#progress").attr("title", pct.toString() + "% completed!");
            $("#progress").tooltip({
                'placement': 'bottom'
            });
            $("#total").text(data.total);
            $("#done").text(data.done);
        });
    }

    // uses device.js and works out what device we are using
    function whatDevice() {
        var desktop = device.desktop(),
            mobile = device.mobile(),
            tablet = device.tablet(),
            portrait = device.portrait(),
            landscape = device.landscape(),
            iphone = device.iphone(),
            android = device.android(),
            androidTablet = device.androidTablet(),
            blackberryTablet = device.blackberryTablet();


        if (desktop) return "Desktop";
        if (mobile && portrait)    return "Mobile portrait";
        if (mobile && portrait)    return "Mobile landscape";
        if (tablet && portrait)    return "Tablet portrait";
        if (tablet && landscape)    return "Tablet landscape";
    }

    // Using useragent we find what browser we are using
    function whatBrowser() {
        var ua = navigator.userAgent, tem,
            M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
        if (/trident/i.test(M[1])) {
            tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
            return 'IE ' + (tem[1] || '');
        }
        if (M[1] === 'Chrome') {
            tem = ua.match(/\bOPR\/(\d+)/);
            if (tem != null) return 'Opera ' + tem[1];
        }
        M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
        if ((tem = ua.match(/version\/(\d+)/i)) != null) M.splice(1, 1, tem[1]);
        return M.join(' ');
    }


    /*
     *
     * PyBossa stuff
     * - .taskLoaded
     * - .presentTask
     *      - .saveTask
     *
     */

    pybossa.taskLoaded(function (task, deferred) {

        if (!$.isEmptyObject(task)) {
            // load image from flickr
            var img = $('<img />');
            img.load(function () {
                // continue as soon as the image is loaded
                deferred.resolve(task);
            });

            img.attr('src', task.info.url_b).css('height', 460);
            img.attr('data-zoom-image', task.info.url_b);
            img.addClass('img-polaroid');
            task.info.image = img;


            task.answer = {
                squares: [],
                timeTaken: "",
                device: "",
                browser: "",
                img: "",
                openModalCount: 0
            }

        } else {
            deferred.resolve(task);
        }
    });

    pybossa.presentTask(function (task, deferred) {

        if (!$.isEmptyObject(task)) {

            loadUserProgress();


            /*
             * Take a time stamp of the time the page loads
             */
            var oldTime = new Date();

            $('#photo-link').html('').append(task.info.image);
            $("#question").html(task.info.question);
            $('#task-id').html(task.id);

            /*
             * Init my Grid Constructor
             */

            var r = new Grid(task);
            r.createGrid();

            var selectBtn = document.getElementById("selectAllBtn");
            selectBtn.onclick = function () {
                r.selectAllSquares();
            }
            var deselectBtn = document.getElementById("deselectBtn");
            deselectBtn.onclick = function () {
                r.deselectAllSquares();
            }

            //Launch tutorial modal
            var openModalCount = 0;
            var modalBtn = document.getElementById("modalBtn");
            modalBtn.onclick = function () {
                $.removeData($(".img-polaroid"), 'elevateZoom');
                $('.zoomContainer').remove();
                $('.zoomWindowContainer').remove();
                $("#modal").modal('show');
                $('.carousel').carousel();

                openModalCount++;
            };



            // On click of the "next slide" button
            $('.btn-answer').off('click').on('click', function () {



                    // Grab a new timestamp and find out the difference
                    // This is how long the user has been on the task for
                    // Then pass it into the answer
                    var newTime = new Date(),
                        ms = newTime - oldTime,
                        x = ms / 1000,
                        seconds = (((x % 31536000) % 86400) % 3600) % 60;

                    // Pass image number into answer
                    var imgUrl = task.info.url_b;
                    var result = imgUrl.replace("//citscitools.cancerresearchuk.org/static/img/mvp-01/", "");

                    // Create the answer object
                    var answer = {
                        squares: [],
                        timeTaken: seconds,
                        device: whatDevice(),
                        browser: whatBrowser(),
                        imgNumber: result,
                        openModalCount: openModalCount
                    };


                    // Change the square object to have clearer values
                    $.each(r.task.answer.squares, function (key, value) {
                        var obj = {
                            column: value.column,
                            row: value.row,
                            answer: value.has_cancer
                        };
                        answer.squares.push(obj);
                    });

                    console.log(answer);

                    /*
                     * Save the task information and send to PyBossa
                     */
                    pybossa.saveTask(task.id, answer).done(function (data) {
                        $("#success").fadeIn(500).delay(500).fadeOut();
                        $("svg, .zoomContainer,.zoomWindowContainer").remove();
                        deferred.resolve();
                    });

                //$("#loading").fadeIn(500).delay(500).fadeOut();

            });


        } else {

            $("#loading").hide();
            $("#finish").fadeIn(500);
            $(".span6").fadeTo( "slow" , 0.5);
        }
    });


    /**
     *
     * app.js
     * General app stuff like inits and buttons listeners
     *
     */

    $(function () {
        pybossa.run('mvp-02a');
    })


    /*
     * Modal
     *
     */

    var step = -1;
    function showStep(action) {
        $("#" + step).hide();

        if (action == 'next') {
            step += 1;
        }
        if (action == 'prev') {
            step -= 1;
        }

         if (step == 0) {
            $("#prevBtn").hide();
        } else {
            $("#prevBtn").show();
        }

        if (step == 13) {
            $("#nextBtn").hide();
            $("#goBackBtn").show();
        } else {
            $("#nextBtn").show();
            $("#goBackBtn").hide();
        }
        $("#" + step).show();




        switch (step) {
            case 8:
                $.removeData($(".img-polaroid"), 'elevateZoom');
                $('.zoomContainer').remove();
                $('.zoomWindowContainer').remove();
                $("#zoom01").elevateZoom();
                break;
            case 9:
                $.removeData($(".img-polaroid"), 'elevateZoom');
                $('.zoomContainer').remove();
                $('.zoomWindowContainer').remove();
                $("#zoom02").elevateZoom();
                break;
            case 10:
                $.removeData($(".img-polaroid"), 'elevateZoom');
                $('.zoomContainer').remove();
                $('.zoomWindowContainer').remove();
                $("#zoom03").elevateZoom();
                break;
            case 11:
                $.removeData($(".img-polaroid"), 'elevateZoom');
                $('.zoomContainer').remove();
                $('.zoomWindowContainer').remove();
                $("#zoom04").elevateZoom();
                break;
            case 12:
                $.removeData($(".img-polaroid"), 'elevateZoom');
                $('.zoomContainer').remove();
                $('.zoomWindowContainer').remove();
                $("#zoom05").elevateZoom();
                break;
            case 13:
                $.removeData($(".img-polaroid"), 'elevateZoom');
                $('.zoomContainer').remove();
                $('.zoomWindowContainer').remove();
                $("#zoom06").elevateZoom();
                break;
            default:
                console.log(step);
        }

    }

    showStep('next');
    var openModalCount = 0;


    var nextBtn = document.getElementById("nextBtn");
    nextBtn.onclick = function () {
        showStep('next');
    };
    var prevBtn = document.getElementById("prevBtn");
    prevBtn.onclick = function () {
        showStep('prev');
    };







//    var csrftoken = "{{ csrf_token() }}";

//    $.ajaxSetup({
//        beforeSend: function (xhr, settings) {
//            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
//                xhr.setRequestHeader("X-CSRFToken", csrftoken);
//            }
//        }
//    });

</script>



